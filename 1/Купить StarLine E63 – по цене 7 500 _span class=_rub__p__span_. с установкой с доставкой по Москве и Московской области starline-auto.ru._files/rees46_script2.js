"use strict";if(typeof console=="undefined"||typeof console.log=="undefined")console={},console.log=function(){};var REES46={ssid:null,user_id:null,user_location:null,shop_id:null,initialized:!1,profile:null,development:!1,debug:!1,_API_URL:null,_SUBSCRIPTIONS_URL:null,URL_PUSH:null,URL_PUSH_ATTRIBUTES:null,URL_RECOMMENDER:null,testingGroup:null,callback:null,recommenderTypes:["interesting","also_bought","popular","similar","recently_viewed","see_also","buying_now","trigger_mail","digest_mail","r46_returner","search"],recommenderNames:{interesting:"",also_bought:"",popular:"",similar:"",recently_viewed:"",see_also:"",buying_now:""},_subscriptionSettings:{enabled:!1},init:function(e,t,n){REES46.debug==1&&REES46._log("Включен режим отладки."),REES46.development==1&&REES46._log("Включен режим локальной разработки.");if(REES46.isBot())return!1;if(e==null||e=="")return REES46._logError("Не указан shop_id."),!1;REES46.shop_id=e;var r=location.href.match("r46_merger=([^&]*)");if(r&&Object.prototype.toString.call(r)=="[object Array]"&&r.length>1)try{var i=atob(unescape(r[1]).replace("\n",""));i&&/^([\w-]+(?:.[\w-]+)*)@((?:[\w-]+.)*\w[\w-]{0,66}).([a-z]{2,6}(?:.[a-z]{2})?)$/i.test(i)&&(REES46.user_email=i)}catch(s){}t!=null&&t!=""&&t!="null"&&(typeof t=="string"||typeof t=="number"?t!=0&&t!="0"&&t!=null&&(REES46.user_id=t):typeof t=="object"&&(t.id!=0&&t.id!=null&&t.id!="0"&&t.id!=""&&(REES46.user_id=t.id),t.email!=null&&t.email!=""&&(REES46.user_email=t.email),t.location!=null&&t.location!=""&&(REES46.user_location=t.location))),REES46.callback=n,REES46._setApiUrl(),REES46.appendInitServerScript()},_setApiUrl:function(){this._API_URL=this.getProtocol(),this.development==1?this._API_URL+="127.0.0.1:8080":this._API_URL+="api.rees46.com"},isBot:function(){var e=["YandexMetrika","Googlebot","bingbot","Screenshot Bot","YandexAntivirus","PEBOT"];for(var t=0,n=e.length;t<n;t++){var r=e[t];if(navigator.userAgent.indexOf(r)!==-1)return!0}return!1},appendInitServerScript:function(){var e=document.createElement("script");e.type="text/javascript";var t=REES46.getCookie("rees46_session_id");e.src=this._API_URL+"/init_script.js?rees46_session_id="+t+"&shop_id="+this.shop_id,document.body.appendChild(e),REES46._log("Инициализация для shop_id="+this.shop_id+" и ssid="+t+".")},getProtocol:function(){return"https:"==document.location.protocol?"https://":"http://"},initServer:function(e){try{return this.validateInitOptions(e),this.applyInitOptions(e),this.storeSource(),this.markDMP(e.ssid,e.sync),this.storeProfile(e.profile),this.initialized=!0,this.callback&&this.callback(),this.reportEventsFromCookies(),this.subscriptions.init(e.subscriptions),this.webPushSubscription.init(e.web_push_subscriptions),REES46._log("Инициализация успешно завершена."),this.dispatchReadyEvent(),!0}catch(t){return REES46._logError(t.message+"\n"+t.stack),!1}},validateInitOptions:function(e){if(this.isBot())throw new Error("REES46.initServer: bot detected");if(this.ssid!=null)throw new Error("REES46.initServer: already initialized with ssid "+this.ssid);if(!e)throw new Error("REES46.initServer: options is undefined");if(!e.ssid)throw new Error("REES46.initServer: ssid is undefined");if(!e.baseURL)throw new Error("REES46.initServer: baseURL is undefined")},applyInitOptions:function(e){this.setSsid(e.ssid),this.setUrls(e.baseURL),this.setTestingGroup(e.testingGroup),this.currency=e.currency,this.showPromotion=e.showPromotion},markDMP:function(e,t){if(t)for(var n in t)if(t.hasOwnProperty(n)){var r=document.createElement("img");r.src=t[n],r.style.width=0,r.style.height=0,r.style.display="none",r.style.position="absolute",r.style.left="-9999px",document.body.appendChild(r)}},storeProfile:function(e){this.profile=e},storeSource:function(){var e={},t=this.getUrlVars().rees46_trigger_mail_code;typeof t!="undefined"&&t!=""&&(e.from="trigger_mail",e.code=t);var n=this.getUrlVars().rees46_digest_mail_code;typeof n!="undefined"&&n!=""&&(e.from="digest_mail",e.code=n);var r=this.getUrlVars().rees46_returner_code;typeof r!="undefined"&&r!=""&&(e.from="r46_returner",e.code=r);var i=this.getUrlVars().rees46_web_push_trigger_code;typeof i!="undefined"&&i!=""&&(e.from="web_push_trigger",e.code=i);var s=this.getUrlVars().rees46_web_push_digest_code;typeof s!="undefined"&&s!=""&&(e.from="web_push_digest",e.code=s),e.from!=undefined&&REES46.setCookie("rees46_source",JSON.stringify(e),{expires:172800,path:"/"})},fetchSource:function(){return REES46.getCookie("rees46_source")},renderTo:function(e,t,n,r){if(r.length>2){var i='<div class="rees46 rees46-recommend"><div class="recommender-block-title">'+t+'</div><div class="recommended-items">',s="";for(var o in r)r.hasOwnProperty(o)&&(s=r[o].url,s+=(/\?/.test(s)?"&":"?")+"recommended_by="+n,i+='<div class="recommended-item"><div class="recommended-item-photo"><a href="'+s+'"><img src="'+r[o].image_url+'"></a></div><div class="recommended-item-title"><a href="'+s+'">'+r[o].name+'</a></div><div class="recommended-item-price">'+parseInt(r[o].price)+" "+REES46.currency+'</div><div class="recommended-item-action"><a href="'+s+'">Подробнее</a></div></div>');i+="</div></div>",document.getElementById(e).innerHTML=i}},setSsid:function(e){this.ssid=e,REES46.setCookie("rees46_session_id",e,{expires:31536e4,path:"/"})},setUrls:function(e){e=e.replace(/http:\/\//,this.getProtocol()),this.URL_PUSH=e+"/push",this.URL_PUSH_ATTRIBUTES=e+"/push_attributes",this.URL_SUBSCRIBE_FOR_PRODUCT_AVAILABLE=e+"/subscriptions/subscribe_for_product_available",this.URL_SUBSCRIBE_FOR_PRODUCT_PRICE=e+"/subscriptions/subscribe_for_product_price",this.URL_RECOMMENDER=e+"/recommend",this._SUBSCRIPTIONS_URL=e+"/subscriptions"},setTestingGroup:function(e){this.testingGroup=e,REES46.setCookie("rees46_ab_testing_group",e,{expires:31536e4,path:"/"})},pushData:function(e,t,n,r){if(!this.initialized)return REES46._logError("REES46 is not initialized. You must to initialize REES46 before tracking."),!1;if(this.isBot())return!1;REES46._log("Событие: "+e+".");if(e!=="view"&&e!=="cart"&&e!=="purchase"&&e!=="rate"&&e!=="remove_from_cart")return REES46._logError("Неизвестный тип события: "+e+"."),!1;var i="";i+="event="+encodeURIComponent(e)+"&shop_id="+encodeURIComponent(this.shop_id)+"&ssid="+encodeURIComponent(this.ssid),this.user_id!=null&&(i+="&user_id="+encodeURIComponent(this.user_id)),this.user_email!=null&&(i+="&user_email="+encodeURIComponent(this.user_email)),this.user_location!=null&&(i+="&user_location="+encodeURIComponent(this.user_location));var s=this.getUrlVars().rees46_trigger_mail_code;typeof s!="undefined"&&(i+="&trigger_mail_code="+encodeURIComponent(s));var o=this.getUrlVars().rees46_digest_mail_code;typeof o!="undefined"&&(i+="&digest_mail_code="+encodeURIComponent(o));var u=this.getUrlVars().rees46_returner_code;typeof u!="undefined"&&(i+="&returner_code="+encodeURIComponent(u));var a=this.getUrlVars().rees46_web_push_trigger_code;typeof a!="undefined"&&a!=""&&(i+="&web_push_trigger_code="+encodeURIComponent(a));var a=this.getUrlVars().rees46_web_push_digest_code;typeof a!="undefined"&&a!=""&&(i+="&web_push_digest_code="+encodeURIComponent(a));var f=null,l=this.getUrlVars().recommended_by;typeof l!="undefined"&&l!=null&&l!=""&&(f=l),t.hasOwnProperty("recommended_by")&&(f=t.recommended_by,delete t.recommended_by),typeof r!="undefined"&&r!=null&&r!=""&&(f=r),f!==null&&(i+="&recommended_by="+encodeURIComponent(f)),typeof n!="undefined"&&n!=null&&n!="null"&&(i+="&order_id="+encodeURIComponent(n));var c=REES46.fetchSource();c&&(i+="&source="+encodeURIComponent(c));var h;return this.is_array(t)?h=this.buildFromArray(t):h=this.buildFromObj(t),h===!1?!1:h===!1?!1:(i+=h,this.ajax(this.URL_PUSH,"POST",i,function(e){}),!0)},recommend:function(e,t,n){if(!this.initialized)return REES46._logError("Модуль не инициализирован. Получить рекомендации можно только после полной инициализации модуля."),!1;if(this.isBot())return!1;if(this.recommenderTypes.indexOf(e.recommender_type)==-1)return REES46._logError("Неизвестный тип рекомендера: "+e.recommender_type),!1;if(typeof t!="function")return REES46._logError("В параметр callback запроса рекомендаций должна быть передана функция."),!1;if(e.recommender_type!="search"||typeof e.search_query!="undefined"&&e.search_query!==""&&e.search_query!==null){var r="";r+="shop_id="+encodeURIComponent(this.shop_id),r+="&ssid="+encodeURIComponent(this.ssid),r+="&recommender_type="+encodeURIComponent(e.recommender_type);if(e.cart&&typeof e.cart=="object"&&e.cart.length>0)r+=this.recBuildFromArray(e.cart);else if(e.recommender_type=="see_also")return REES46._logError("Для рекомендера see_also должны быть переданы id товаров в корзине."),!1;e.locations&&(r+="&locations="+encodeURIComponent(e.locations)),e.extended&&(r+="&extended="+encodeURIComponent(e.extended)),e.discount&&(r+="&discount="+encodeURIComponent(e.discount)),e.modification&&(r+="&modification="+encodeURIComponent(e.modification)),e.search_query&&(r+="&search_query="+encodeURIComponent(e.search_query)),e.category&&(r+="&category="+encodeURIComponent(e.category)),e.categories&&(typeof categories=="object"?r+="&categories="+encodeURIComponent(e.categories.join(",")):r+="&categories="+encodeURIComponent(e.categories)),e.item&&(r+="&item_id="+encodeURIComponent(e.item)),e.limit&&(r+="&limit="+encodeURIComponent(e.limit));if(e.filterBy)for(var i in e.filterBy)e.filterBy.hasOwnProperty(i)&&(r+="&custom_attributes_filter["+i+"]="+e.filterBy[i]);return this.ajax(this.URL_RECOMMENDER,"GET",r,t),!0}return REES46._logError("Search query is empty while using search recommender."),!1},ajax:function(e,t,n,r){if(this.corsAvailable()===!1)return!1;var i=function(){if(u.readyState==4&&u.status==200){var e=u.responseText;e=JSON.parse(e),typeof r=="function"&&r(e)}},s=function(){var e=u.responseText;e=JSON.parse(e),typeof r=="function"&&r(e)};try{var o=window.XDomainRequest||window.XMLHttpRequest,u=new o;return u.withCredentials="true",o==window.XDomainRequest?(u.open(t,e+"?"+n,!0),u.onload=s,u.onerror=function(){REES46._logError("Request error.")},u.send(null),this._xml=u,this._xml):(t=="POST"&&u.open(t,e,!0),t=="GET"&&u.open(t,e+"?"+n,!0),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.onload=i,u.onerror=function(){REES46._logError("Request error.")},t=="POST"&&u.send(n),t=="GET"&&u.send(null),this._xml=u,this._xml)}catch(a){}return!0},buildFromArray:function(e){var t="",n=e.length;t+="&count="+n;if(n!==0){var r;for(var i in e)if(e.hasOwnProperty(i)){r=e[i];if(!r.hasOwnProperty("item_id"))return REES46._logError("Товаров несколько, не передан item_id."),!1;r.hasOwnProperty("categories")&&typeof r["categories"]=="object"&&(r.categories=r.categories.join(",")),r.hasOwnProperty("attributes")&&typeof r["attributes"]=="object"&&(r.attributes=JSON.stringify(r.attributes));if(r.item_id===null||r.item_id===""||typeof r.item_id=="undefined")return REES46._logError("Не передан item_id."),!1;for(var s in r)r.hasOwnProperty(s)&&r[s]!==null&&r[s]!==""&&(t+="&"+s+"["+i+"]="+encodeURIComponent(r[s]))}return t}return REES46._log("PUSH: 0 товаров"),!1},recBuildFromArray:function(e){var t="",n=e.length;t+="&cart_count="+n;if(n!==0){for(var r in e)if(e.hasOwnProperty(r)){if(e[r]===null||e[r]==="")return REES46._logError('Рекомендер also_bought, товаров корзины несколько, id одного из товаров null или "".'),!1;t+="&cart_item_id["+r+"]="+encodeURIComponent(e[r])}return t}return REES46._log("PUSH: 0 товаров"),!1},buildFromObj:function(e){var t="";e["count"]=="undefined"||e["count"]==null?t+="&count=1":t+="&count="+e.count;if(e.hasOwnProperty("item_id")){e.hasOwnProperty("categories")&&typeof e["categories"]=="object"&&(e.categories=e.categories.join(",")),e.hasOwnProperty("attributes")&&typeof e["attributes"]=="object"&&(e.attributes=JSON.stringify(e.attributes));if(e.item_id===null||e.item_id===""||typeof e.item_id=="undefined")return REES46._logError("Не передан item_id."),!1;for(var n in e)e.hasOwnProperty(n)&&n!=="count"&&e[n]!==null&&e[n]!==""&&(t+="&"+n+"[0]="+encodeURIComponent(e[n]));return t}return REES46._log("PUSH: нет item_id"),!1},is_array:function(e){return typeof e=="object"&&e instanceof Array},getUrlVars:function(){var e={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,n,r){e[n]=r.split("#")[0]}),e},corsAvailable:function(){return!document.all||!!document.querySelector},_log:function(e){this.debug&&(typeof console!="undefined"?console.log("REES46: "+e):alert(e))},_logError:function(e){typeof console!="undefined"?console.log("Ошибка в REES46: "+e):alert(e)},getCookie:function(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):""},setCookie:function(e,t,n){n=n||{};var r=n.expires;if(typeof r=="number"&&r){var i=new Date;i.setTime(i.getTime()+r*1e3),r=n.expires=i}r&&r.toUTCString&&(n.expires=r.toUTCString()),t=encodeURIComponent(t);var s=e+"="+t;for(var o in n){s+="; "+o;var u=n[o];u!==!0&&(s+="="+u)}document.cookie=s},pushAttributes:function(e){if(!this.initialized)return REES46._logError("Модуль не инициализирован. Отправлять аттрибуты можно только после полной инициализации модуля."),!1;if(this.isBot())return!1;var t="&shop_id="+encodeURIComponent(this.shop_id)+"&session_id="+encodeURIComponent(this.ssid);for(var n in e)e.hasOwnProperty(n)&&(t=t+"&attributes["+n+"]="+encodeURIComponent(e[n]));return REES46._log(t),REES46.ajax(REES46.URL_PUSH_ATTRIBUTES,"POST",t),!0},inRees46recommendersTestingGroup:function(){return this.testingGroup==2},isGroupA:function(){return this.testingGroup!=2},isGroupB:function(){return this.testingGroup==2},reportEventsFromCookies:function(){var e=this.getCookie("rees46_recommended_by");if(this.getCookie("rees46_track_cart")!=""){REES46._log(this.getCookie("rees46_track_cart"));var t=JSON.parse(this.getCookie("rees46_track_cart"));this.pushData("cart",t,null,e),this.setCookie("rees46_track_cart","",{expires:31536e4,path:"/"})}if(this.getCookie("rees46_track_remove_from_cart")!=""){var n=JSON.parse(this.getCookie("rees46_track_remove_from_cart"));this.pushData("remove_from_cart",n,null,e),this.setCookie("rees46_track_remove_from_cart","",{expires:31536e4,path:"/"})}if(this.getCookie("rees46_track_purchase")!=""){var r=JSON.parse(this.getCookie("rees46_track_purchase"));this.pushData("purchase",r.items,r.order_id,e),this.setCookie("rees46_track_purchase","",{expires:31536e4,path:"/"})}this.setCookie("rees46_recommended_by","",{expires:31536e4,path:"/"})},dispatchReadyEvent:function(){if(document.createEvent){var e=document.createEvent("Event");e.initEvent("REES46.ready",!0,!0),document.dispatchEvent(e)}},addReadyListener:function(e){this.initialized==1?e():document.addEventListener&&document.addEventListener("REES46.ready",e,!1)},getPromotionBlock:function(){return'<div style="margin-top: -15px;"><a href="http://rees46.com/?utm_source='+encodeURIComponent(document.location.origin)+'&utm_medium=free_link&utm_campaign=block_link" style="font-size: 9px; color: darkgreen; text-decoration: none;" target="_blank">REES46 - технологии персонализации</a></div>'},addStyleToPage:function(){if(this.initialized!=1){REES46._logError("Добавлять стиль на страницу нужно после инициализации модуля. Стили не будут добавлены.");return}var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href","//rees46.com/shop_css/"+this.shop_id+".css"),document.getElementsByTagName("head")[0].appendChild(e)},_isMobileDevice:function(){var e=!1;return function(t,n){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))e=!0}(navigator.userAgent||navigator.vendor||window.opera),e},subscriptions:{_settings:null,_subscribeButtonsClassName:"rees46-subscribe-button",_userInfoCookieName:"rees46_subscription",_userSubscription:null,_currentUserInfo:null,_popupInterval:12e4,init:function(e){if(e.settings){this._settings=e.settings,this._picture_url=e.picture_url,REES46._isMobileDevice()&&(this._log("отключен для мобильных устройств."),this._settings.enabled=!1),e.user&&(this._userSubscription=e.user);if(this._settings.enabled==1){this._log("включен."),this._addStyleToPage(),this._fetchUserInfo();if(this._userSubscription){if(this._userSubscription.declined==1||this._userSubscription.active==1)this._currentUserInfo.showed=!0,this._saveUserInfo();this._userSubscription.declined==0&&this._removeSubscribeButtons()}(this._userSubscription==null||this._userSubscription.declined==1)&&this._activateSubscribeButtons(),this._currentUserInfo.showed==0?(this._log("пользователю еще не было показано окно сбора e-mail."),this._fetchPopupInterval(),this._schedulePopup()):this._log("пользователю уже было показано окно сбора e-mail.")}else this._removeSubscribeButtons(),this._log("выключен.")}else this._removeSubscribeButtons(),this._log("неактивен.");this._users()},_users:function(){var e=setInterval(function(){var t=["login","mail","user"],n=document.getElementsByTagName("input");[].forEach.call(n,function(n){var r=n.attributes;r.length>0&&[].forEach.call(r,function(r){var i=r.value;return t.some(function(t){return i.toLowerCase().indexOf(t)+1&&(n.onblur=function(){var t=n.value.trim(),r=/^([\w-]+(?:.[\w-]+)*)@((?:[\w-]+.)*\w[\w-]{0,66}).([a-z]{2,6}(?:.[a-z]{2})?)$/i;r.test(t)&&(clearInterval(e),REES46.pushAttributes({email:t}))})})})})},100)},_log:function(e){REES46._log("Сбор e-mail: "+e)},popup:function(){this._settings&&this._settings.enabled==1?(this._log("показ окна сбора."),this._drawPopup(),this._currentUserInfo.showed=!0,this._saveUserInfo()):this._log("попытка показать окно при выключенной функции сбора.")},_schedulePopup:function(){this._log("планирование времени показа.");var e=this._currentUserInfo.firstVisited+this._popupInterval,t=(new Date).getTime();if(e<=t)this._log("будет показано сейчас."),this.popup();else{var n=e-t;this._log("будет показано через "+n+" мс.");var r=setInterval(function(){REES46.subscriptions._currentUserInfo.showed==1?REES46.subscriptions.log("было показано ранее, отмена показа."):REES46.subscriptions.popup(),clearInterval(r)},n)}},_fetchPopupInterval:function(){var e="rees46_popup_interval",t=REES46.getUrlVars()[e];if(typeof t!="undefined"&&t!=null&&t!="")this._popupInterval=parseInt(t)*1e3,REES46.setCookie(e,t,{expires:31536e4,path:"/"});else{var n=REES46.getCookie(e);typeof n!="undefined"&&n!=null&&n!=""&&(this._popupInterval=parseInt(n)*1e3)}},_addStyleToPage:function(){this._log("добавление стиля окна сбора e-mail на страницу.");var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href","//rees46.com/popup_css/"+REES46.shop_id+".css"),document.getElementsByTagName("head")[0].appendChild(e)},_activateSubscribeButtons:function(){var e=document.getElementsByClassName(this._subscribeButtonsClassName);if(e.length>0)for(var t=e.length-1;t>=0;t--)e[t].onclick=function(){var e=this.getAttribute("data-rees46-popup-header");e!=null&&(REES46.subscriptions._settings.header=e);var t=this.getAttribute("data-rees46-popup-text");return t!=null&&(REES46.subscriptions._settings.text=t),REES46.subscriptions.popup(),!1}},_removeSubscribeButtons:function(){var e=document.getElementsByClassName(this._subscribeButtonsClassName);if(e.length>0){this._log("удаление кнопок подписки со страницы.");for(var t=e.length-1;t>=0;t--)e[t].remove()}},_fetchUserInfo:function(){var e={firstVisited:(new Date).getTime(),showed:!1},t=REES46.getCookie(this._userInfoCookieName);t!=""?(this._log("пользователь опознан."),e=JSON.parse(t)):this._log("неизвестный пользователь."),this._currentUserInfo=e,this._saveUserInfo()},_saveUserInfo:function(){REES46.setCookie(this._userInfoCookieName,JSON.stringify(this._currentUserInfo),{expires:31536e4,path:"/"})},_drawPopup:function(){var e="<div style='opacity:0; visibility:hidden;' id='rees46-popup' class='rees46-popup "+(this._settings.overlay?"":"rees46-popup_side")+"'>"+"<div id='rees46-popup-modal' class='rees46-popup__wrap'>"+"<div class='rees46-popup__content'>"+"<h1>"+this._settings.header+"</h1>"+"<div id='rees46-popup-content'>";this._picture_url!=null&&(e+="<img class='rees46-popup-image' src='"+this._picture_url+"'>"),e+="<p class='rees46-popup__intro'>"+this._settings.text+"</p>"+"<form id='rees46-subscription'>"+"<div class='rees46-popup__form_elem rees46-popup__hidden'>"+"<input type='hidden' id='rees46-subscription-name' placeholder='Имя'>"+"</div>"+"<div class='rees46-popup__form_elem rees46-popup__hidden'>"+"<input type='hidden' id='rees46-subscription-surname' placeholder='Фамилия'>"+"</div>"+"<div class='rees46-popup__form_elem'>"+"<input type='text' id='rees46-subscription-email' placeholder='E-mail' tabindex='1'>"+"<button type='submit' id='rees46-subscription-submit' class='rees46-popup__button'>"+this._settings.button+"</button>"+"</div>"+"<label class='rees46-popup__checkbox'>"+"<input type='checkbox' id='rees46-subscription-success' checked>"+this._settings.agreement+"</label>"+"</form>"+"</div>"+"<span id='rees46-popup-close' class='rees46-popup__close'></span>"+"</div>"+"</div>"+"</div>";if(!document.body.insertAdjacentHTML)return!1;document.body.insertAdjacentHTML("beforeEnd",e);var t=document.getElementById("rees46-popup"),n=document.getElementById("rees46-popup-modal"),r=document.getElementById("rees46-subscription-name"),i=document.getElementById("rees46-subscription-surname"),s=document.getElementById("rees46-subscription-email"),o=document.getElementById("rees46-subscription-success"),u=!1,a,f=function(e){var t=new Date,n=setInterval(function(){var r=(new Date-t)/e.duration;r>1&&(r=1),e.step(r),r==1&&(clearInterval(n),e.complete&&e.complete())},e.delay||10)},l=getComputedStyle(n,null),c=parseInt(l.height)+parseInt(l.paddingTop)+parseInt(l.paddingBottom),h=parseInt(l.width)+parseInt(l.paddingTop)+parseInt(l.paddingBottom),p=parseInt(document.documentElement.clientHeight*10/100),d=function(e){f({duration:250,step:function(t){e.style.opacity=t*1},complete:function(){s.focus()}})},v=function(e){if(REES46.subscriptions._settings.overlay==1)var n=-c,r=p;else var n=-h,r=0;f({duration:250,step:function(t){REES46.subscriptions._settings.overlay==1?e.style.marginTop=n+(r-n)*t+"px":e.style.right=n+(r-n)*t+"px"},complete:function(){if(REES46.subscriptions._settings.overlay!=1)return!1;t.style.overflow="auto"}})},m=function(e){var t=1,n=0;f({duration:250,step:function(r){e.style.opacity=t+(n-t)*r}})},g=function(e){if(REES46.subscriptions._settings.overlay==1)var n=p,r=-c;else{var n=0,r=-h;t.style.overflow="hidden"}f({duration:250,step:function(t){REES46.subscriptions._settings.overlay==1?e.style.marginTop=Math.round(n+(r-n)*t)+"px":e.style.right=Math.round(n+(r-n)*t)+"px"},complete:function(){t.parentNode.removeChild(t)}})};d(t),v(n);var y=function(){if(u==0){var e="&declined=true";e+="&shop_id="+encodeURIComponent(REES46.shop_id),e+="&ssid="+encodeURIComponent(REES46.ssid),REES46.ajax(REES46._SUBSCRIPTIONS_URL,"POST",e),REES46.subscriptions._log("пользователь отказался от подписки, данные успешно отправлены на сервер.")}m(t),g(n)};t.onclick=function(e){if(REES46.subscriptions._settings.overlay==1){if(e.target===this||e.target===document.getElementById("rees46-popup-close"))clearTimeout(a),y()}else e.target===document.getElementById("rees46-popup-close")&&(clearTimeout(a),y())},document.onkeydown=function(e){e=e||window.event,e.keyCode==27&&(clearTimeout(a),y())};var b=function(e){e.value=e.value.substr(0,250)};r.onkeypress=r.onchange=i.onkeypress=i.onchange=s.onkeypress=s.onchange=function(){b(this)};var w=function(){function p(){var e=r.value,t=i.value,n=s.value,o="name="+encodeURIComponent(e+" "+t);o+="&email="+encodeURIComponent(n),o+="&declined=false",o+="&shop_id="+encodeURIComponent(REES46.shop_id),o+="&ssid="+encodeURIComponent(REES46.ssid),REES46.subscriptions._log("пользователь подписался, данные успешно отправлены на сервер."),REES46.ajax(REES46._SUBSCRIPTIONS_URL,"POST",o),document.getElementById("rees46-popup-content").innerHTML="<p class='rees46-popup__text'>Отлично! Мы оповестим вас об индивидуальных предложениях.</p>",u=!0,REES46.subscriptions._removeSubscribeButtons(),a=setTimeout(function(){y()},2e3)}var e=r.value,t=i.value,n=s.value,f=!0,l=!0;if(!/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(n)){s.setAttribute("class","rees46-popup-error"),l==1&&(s.focus(),l=!1),f=!1;if(document.getElementById("email-error")==null){var c=document.createElement("p");c.setAttribute("class","rees46-popup-note"),c.setAttribute("id","email-error"),c.innerHTML=c.innerHTML+"укажите корректный e-mail",s.parentNode.appendChild(c)}}else{s.className=s.className.replace(" rees46-popup-error","").replace("rees46-popup-error","");if(document.getElementById("email-error")!=null){var h=document.getElementById("email-error");h.parentNode.removeChild(h)}}o.checked?o.parentNode.className=o.parentNode.className.replace(" rees46-popup-error","").replace("rees46-popup-error",""):(o.parentNode.className+=" rees46-popup-error",f=!1,l==1&&o.focus()),f===!0&&p()};document.getElementById("rees46-subscription-submit").onclick=function(e){e.preventDefault(),w()}}},subscribe_for_product_available:function(e,t){if(/^([\w-]+(?:.[\w-]+)*)@((?:[\w-]+.)*\w[\w-]{0,66}).([a-z]{2,6}(?:.[a-z]{2})?)$/i.test(e)&&t){var n="";return n+="shop_id="+encodeURIComponent(this.shop_id),n+="&ssid="+encodeURIComponent(this.ssid),n+="&email="+encodeURIComponent(e),n+="&item_id="+encodeURIComponent(t),REES46.ajax(REES46.URL_SUBSCRIBE_FOR_PRODUCT_AVAILABLE,"POST",n),!0}return!1},subscribe_for_product_price:function(e,t,n){if(/^([\w-]+(?:.[\w-]+)*)@((?:[\w-]+.)*\w[\w-]{0,66}).([a-z]{2,6}(?:.[a-z]{2})?)$/i.test(e)&&t&&parseFloat(n)>0){var r="";return r+="shop_id="+encodeURIComponent(this.shop_id),r+="&ssid="+encodeURIComponent(this.ssid),r+="&email="+encodeURIComponent(e),r+="&item_id="+encodeURIComponent(t),r+="&price="+encodeURIComponent(parseFloat(n)),REES46.ajax(REES46.URL_SUBSCRIBE_FOR_PRODUCT_PRICE,"POST",r),!0}return!1},webPushSubscription:{_settings:null,_subscribeButtonsClassName:"rees46-web-push-subscribe-button",_userInfoCookieName:"rees46_web_push_subscription",_safari_push_id:"rees46.com",_userSubscription:null,_currentUserInfo:null,_popupInterval:3e4,available:!1,initialized:!1,registration:null,subscription:null,init:function(e){if(e.settings&&!e.user.declined){this._settings=e.settings,this._picture_url=e.picture_url,e.user&&(this._userSubscription=e.user);if(this.enabled()&&this.access()){this._log("включен."),this.available=!0,this.registerServiceWorker(),this._addStyleToPage(),this._fetchUserInfo();if(this._userSubscription){if(this._userSubscription.declined==1||this._userSubscription.active==1)this._currentUserInfo.showed=!0,this._saveUserInfo();this._userSubscription.declined==1&&this._removeSubscribeButtons()}(this._userSubscription==null||this._userSubscription.declined==0)&&this._activateSubscribeButtons(),typeof this._currentUserInfo.showed=="undefined"||!this._currentUserInfo.showed?(this._log("пользователю еще не было показано окно подписки."),this._fetchPopupInterval(),this._schedulePopup()):this._log("пользователю уже было показано окно веб пуш подписок.")}else this._removeSubscribeButtons(),this._log("выключен.")}else this._removeSubscribeButtons(),this._log("неактивен.")},enabled:function(){return this._settings.enabled==1&&(document.location.hostname=="localhost"||document.location.protocol=="https:")},_log:function(e){REES46._log("Web push subscription: "+e)},popup:function(){this._settings&&this._settings.enabled==1?(this._log("показ окна сбора."),REES46._isMobileDevice()||this._settings.manual_mode==1?this.subscribe():(this._drawPopup(),this._currentUserInfo.showed=!0,this._saveUserInfo())):this._log("попытка показать окно при выключенной функции сбора.")},_schedulePopup:function(){if(this._settings&&this._settings.manual_mode==0){this._log("планирование времени показа.");var e=this._currentUserInfo.firstVisited+this._popupInterval,t=(new Date).getTime(),n=this;if(e<=t)this._log("будет показано сейчас."),this.popup();else{var r=e-t;this._log("будет показано через "+r+" мс.");var i=setInterval(function(){typeof n._currentUserInfo.showed!="undefined"&&n._currentUserInfo.showed?n._log("было показано ранее, отмена показа."):n.popup(),clearInterval(i)},r)}}},_fetchPopupInterval:function(){var e="rees46_webpush_popup_interval",t=REES46.getUrlVars()[e];if(typeof t!="undefined"&&t!=null&&t!="")this._popupInterval=parseInt(t)*1e3,REES46.setCookie(e,t,{expires:31536e4,path:"/"});else{var n=REES46.getCookie(e);typeof n!="undefined"&&n!=null&&n!=""&&(this._popupInterval=parseInt(n)*1e3)}},_activateSubscribeButtons:function(){var e=document.getElementsByClassName(this._subscribeButtonsClassName);if(e.length>0)for(var t=e.length-1;t>=0;t--)e[t].onclick=function(){var e=this.getAttribute("data-rees46-popup-header");e!=null&&(REES46.webPushSubscription._settings.header=e);var t=this.getAttribute("data-rees46-popup-text");return t!=null&&(REES46.webPushSubscription._settings.text=t),REES46.webPushSubscription.popup(),!1}},_removeSubscribeButtons:function(){var e=document.getElementsByClassName(this._subscribeButtonsClassName);if(e.length>0){this._log("удаление кнопок подписки со страницы.");for(var t=e.length-1;t>=0;t--)e[t].remove()}},_fetchUserInfo:function(){var e={firstVisited:(new Date).getTime(),showed:!1},t=REES46.getCookie(this._userInfoCookieName);t!=""?(this._log("пользователь опознан."),e=JSON.parse(t)):this._log("неизвестный пользователь."),this._currentUserInfo=e,this._saveUserInfo()},_saveUserInfo:function(){REES46.setCookie(this._userInfoCookieName,JSON.stringify(this._currentUserInfo),{expires:31536e4,path:"/"})},registerServiceWorker:function(){if(!this.accessSafari()){var e=document.createElement("link");e.setAttribute("rel","manifest"),e.setAttribute("href","/manifest.json");var t=document.getElementsByTagName("head")[0];t&&document.getElementsByTagName("head")[0].appendChild(e),navigator.serviceWorker.register("/push_sw.js").then(function(){return navigator.serviceWorker.ready}).then(function(e){REES46._log("Service Worker is ready"),REES46.webPushSubscription.initialized=!0,REES46.webPushSubscription.registration=e}).catch(function(e){REES46._logError("Service Worker error :^(",e)}),navigator.serviceWorker.ready.then(function(e){e.pushManager.getSubscription().then(function(e){e&&REES46.webPushSubscription.subscribed(e)})})}},access:function(){return!(this.accessSafari()||"serviceWorker"in navigator&&"showNotification"in ServiceWorkerRegistration.prototype&&"PushManager"in window)||window.navigator.userAgent.indexOf("OPR")>-1||window.navigator.userAgent.indexOf("Opera")>-1?(REES46._log("Notifications aren't supported."),!1):Notification.permission==="denied"?(
REES46._log("The user has blocked notifications."),!1):!0},accessSafari:function(){return"safari"in window&&"pushNotification"in window.safari},checkSafariRemotePermission:function(e){e.permission==="default"?window.safari.pushNotification.requestPermission(REES46._API_URL,this._safari_push_id,{},this.checkSafariRemotePermission):e.permission==="denied"?REES46._log("The user has blocked notifications."):e.permission==="granted"&&console.log(e)},subscribed:function(e){this.subscription=e.toJSON(),this.send_registration_id()},subscribe:function(e,t){this.registration?this.registration.pushManager.subscribe({userVisibleOnly:!0}).then(function(t){REES46.webPushSubscription.subscribed(t),typeof e=="function"&&e()},function(e){REES46.webPushSubscription.unsubscribed(),t(e)}):REES46._logError("Web push service is not registered")},unsubscribe:function(){this.subscription&&this.subscription.unsubscribe().then(function(e){console.log("Unsubscribed!",e),REES46.webPushSubscription.subscription=null,this.unsubscribed()}).catch(function(e){console.log("Error unsubscribing",e)})},unsubscribed:function(){var e=["shop_id="+encodeURIComponent(REES46.shop_id),"ssid="+encodeURIComponent(REES46.ssid)];REES46.ajax(REES46._API_URL+"/web_push_subscriptions/decline","POST",e.join("&")),REES46.webPushSubscription._log("пользователь отказался от подписки, данные успешно отправлены на сервер."),this._removeSubscribeButtons()},send_registration_id:function(){var e=JSON.stringify(this.subscription);REES46._log("registration_id: "+e);var t=["shop_id="+encodeURIComponent(REES46.shop_id),"ssid="+encodeURIComponent(REES46.ssid),"token="+encodeURIComponent(e)].join("&");REES46.ajax(REES46._API_URL+"/web_push_subscriptions","POST",t),this._log("пользователь подписался, данные успешно отправлены на сервер."),this._removeSubscribeButtons()},_addStyleToPage:function(){this._log("Добавление стиля окна подписки на страницу.");var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href","//rees46.com/webpush_popup_css/"+REES46.shop_id+".css"),document.getElementsByTagName("head")[0].appendChild(e)},_drawPopup:function(){var e=this,t="<div style='opacity:0;' id='rees46-web-push-popup' class='rees46-web-push-popup "+(this._settings.overlay?"":"rees46-web-push-popup_side")+"'>"+"<div id='rees46-web-push-popup-modal' class='rees46-web-push-popup__wrap'>"+"<div class='rees46-web-push-popup__content'>"+"<h1>"+this._settings.header+"</h1>"+"<div id='rees46-web-push-popup-content'>";this._picture_url!=null&&(t+="<img class='rees46-web-push-popup-image' src='"+this._picture_url+"'>"),t+="<p class='rees46-web-push-popup__intro'>"+this._settings.text+"</p>"+"<form id='rees46-web-push-subscription'>"+"<div class='rees46-popup__form_elem'>"+"<button type='submit' id='rees46-web-push-subscription-submit' class='rees46-web-push-popup__button'>"+this._settings.button+"</button>"+"</div>"+"<label class='rees46-web-push-popup__checkbox'>"+"<input type='checkbox' id='rees46-web-push-subscription-success' checked>"+this._settings.agreement+"</label>"+"</form>"+"</div>"+"<span id='rees46-web-push-popup-close' class='rees46-web-push-popup__close'></span>"+"</div>"+"</div>"+"</div>";if(!document.body.insertAdjacentHTML)return!1;document.body.insertAdjacentHTML("beforeEnd",t);var n=document.getElementById("rees46-web-push-popup"),r=document.getElementById("rees46-web-push-popup-modal"),i=document.getElementById("rees46-web-push-subscription-success"),s=!1,o,u=function(e){var t=new Date,n=setInterval(function(){var r=(new Date-t)/e.duration;r>1&&(r=1),e.step(r),r==1&&(clearInterval(n),e.complete&&e.complete())},e.delay||10)},a=getComputedStyle(r,null),f=parseInt(a.height)+parseInt(a.paddingTop)+parseInt(a.paddingBottom),l=parseInt(a.width)+parseInt(a.paddingTop)+parseInt(a.paddingBottom),c=parseInt(document.documentElement.clientHeight*10/100),h=function(e){u({duration:250,step:function(t){e.style.opacity=t*1},complete:function(){}})},p=function(e){var t,r;REES46.webPushSubscription._settings.overlay==1?(t=-f,r=c):(t=-l,r=0),u({duration:250,step:function(n){REES46.webPushSubscription._settings.overlay==1?e.style.marginTop=t+(r-t)*n+"px":e.style.right=t+(r-t)*n+"px"},complete:function(){if(REES46.webPushSubscription._settings.overlay!=1)return!1;n.style.overflow="auto"}})},d=function(e){var t=1,n=0;u({duration:250,step:function(r){e.style.opacity=t+(n-t)*r}})},v=function(e){var t,r;REES46.webPushSubscription._settings.overlay==1?(t=c,r=-f):(t=0,r=-l,n.style.overflow="hidden"),u({duration:250,step:function(n){REES46.webPushSubscription._settings.overlay==1?e.style.marginTop=Math.round(t+(r-t)*n)+"px":e.style.right=Math.round(t+(r-t)*n)+"px"},complete:function(){n.parentNode.removeChild(n)}})};h(n),p(r);var m=function(){s==0&&e.unsubscribed(),d(n),v(r)};n.onclick=function(e){if(REES46.webPushSubscription._settings.overlay==1){if(e.target===this||e.target===document.getElementById("rees46-web-push-popup-close"))clearTimeout(o),m()}else e.target===document.getElementById("rees46-web-push-popup-close")&&(clearTimeout(o),m())},document.onkeydown=function(e){e=e||window.event,e.keyCode==27&&(clearTimeout(o),m())};var g=function(e){e.value=e.value.substr(0,250)},y=function(){var e=!0,t=!0;i.checked?i.parentNode.className=i.parentNode.className.replace(" rees46-web-push-popup-error","").replace("rees46-web-push-popup-error",""):(i.parentNode.className+=" rees46-web-push-popup-error",e=!1,t==1&&i.focus());var u=function(){document.getElementById("rees46-web-push-popup-content").innerHTML="<p class='rees46-web-push-popup__text'>Отлично! Мы оповестим вас об индивидуальных предложениях.</p>",s=!0,o=setTimeout(function(){m()},2e3)};e===!0&&REES46.webPushSubscription.subscribe(u,function(){d(n),v(r)})};document.getElementById("rees46-web-push-subscription-submit").onclick=function(e){e.preventDefault(),y()}}}};